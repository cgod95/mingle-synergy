import { useEffect, useState } from "react";
import { NavLink } from "react-router-dom";
import { useAuth } from "../context/AuthContext";
import { getMatchCount, getTotalUnread } from "../lib/matchStore";

export default function Header() {
  
  const [unread, setUnread] = useState<number>(getTotalUnread());
  const [matchesCount, setMatchesCount] = useState<number>(getMatchCount());
const { user, signOutUser } = useAuth();

  // counts

  useEffect(() => {
      const id = setInterval(() => { setUnread(getTotalUnread()); setMatchesCount(getMatchCount()); }, 1000);
// poll every second (simple demo approach)
    const id = setInterval(() => {
      try {
        setMatchesCount(getMatchCount?.() ?? 0);
        setUnread(getTotalUnread?.() ?? 0);
      } catch {
        // ignore
      }
    }, 1000);
    return () => clearInterval(id);
  }, []);

  const badge = (n: number) =>
    n > 0 ? (
      <span
        style={{
          marginLeft: 6,
          background: "#ef4444",
          color: "#fff",
          borderRadius: 10,
          padding: "0px 6px",
          fontSize: 12,
          lineHeight: "18px",
          display: "inline-block",
          minWidth: 18,
          textAlign: "center",
        }}
      >
        {n}
      </span>
    ) : null;

  return (
    <header
      style={{
        display: "flex",
        alignItems: "center",
        justifyContent: "space-between",
        padding: "12px 16px",
        borderBottom: "1px solid #eee",
        position: "sticky",
        top: 0,
        background: "#fff",
        zIndex: 10,
      }}
    >
      <NavLink to="/" style={{ textDecoration: "none", fontWeight: 700, fontSize: 18 }}>
        Mingle
      </NavLink>

      <nav style={{ display: "flex", gap: 12, alignItems: "center" }}>
        <NavLink to="/venues">Venues</NavLink>
          <NavLink to="/matches">Matches</NavLink>
        <NavLink to="/matches">
          Matches {badge(matchesCount)} {unread > 0 && <span style={{ marginLeft: 4 }}>(unread {unread})</span>}
        </NavLink>
        <NavLink to="/profile">Profile</NavLink>
        <NavLink to="/feedback">Feedback</NavLink>
      <span style={{marginLeft:8,fontSize:12,color:'#666'}}>Unread: {unread}</span>
        </nav>

      <div>
        {user ? (
          <button onClick={signOutUser} style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd" }}>
            Sign out
          </button>
        ) : (
          <NavLink to="/sign-in">Sign in</NavLink>
        )}
      </div>
    </header>
  );
}
